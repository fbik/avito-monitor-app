<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avito Messages Monitor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #718096;
        }
        .status-value {
            font-weight: 600;
        }
        .connected {
            color: #48bb78;
        }
        .disconnected {
            color: #f56565;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background: #4299e1;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #3182ce;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background: #e53e3e;
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .messages-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            max-height: 400px;
            overflow-y: auto;
        }
        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .message-count {
            background: #4299e1;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #4299e1;
        }
        .message.new {
            background: #f0fff4;
            border-left-color: #48bb78;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .message-sender {
            font-weight: 700;
            color: #2d3748;
        }
        .message-time {
            color: #718096;
            font-size: 0.9em;
        }
        .message-text {
            color: #4a5568;
            line-height: 1.5;
        }
        .new-badge {
            background: #48bb78;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            color: white;
            z-index: 1000;
        }
        .connection-status.connected {
            background: #48bb78;
        }
        .connection-status.disconnected {
            background: #f56565;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: #48bb78;
            color: white;
            font-weight: 600;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì® Avito Messages Monitor</h1>
        <p class="subtitle">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –†—É—à–∞–Ω –ù–∞—Ç—Ñ—É–ª–ª–∏–Ω –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        
        <div class="status-card">
            <h3>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
            <div class="status-list">
                <div class="status-item">
                    <span class="status-label">WebSocket:</span>
                    <span id="ws-status" class="status-value disconnected">–û—Ç–∫–ª—é—á–µ–Ω</span>
                </div>
                <div class="status-item">
                    <span class="status-label">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Avito:</span>
                    <span id="auth-status" class="status-value disconnected">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                </div>
                <div class="status-item">
                    <span class="status-label">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:</span>
                    <span id="monitor-status" class="status-value disconnected">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
                </div>
                <div class="status-item">
                    <span class="status-label">–°–æ–æ–±—â–µ–Ω–∏–π:</span>
                    <span id="message-count" class="status-value">0</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="login-btn" class="btn btn-primary" onclick="login()">
                üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Avito
            </button>
            <button id="start-btn" class="btn btn-success" onclick="startMonitoring()" disabled>
                ‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            </button>
            <button id="stop-btn" class="btn btn-danger" onclick="stopMonitoring()" disabled>
                ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            </button>
            <button id="clear-btn" class="btn" onclick="clearMessages()" disabled style="background: #a0aec0; color: white;">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
            </button>
        </div>
        
        <div class="messages-container">
            <div class="messages-header">
                <h2>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –†—É—à–∞–Ω–∞</h2>
                <div class="message-count" id="messages-count">0</div>
            </div>
            <div id="messages-list" class="messages-list">
                <div style="text-align: center; color: #718096; padding: 40px;">
                    <div style="width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #4299e1; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                    <p>–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="connection-status" class="connection-status disconnected">
        üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        const API_URL = 'http://localhost:3000';
        let socket = null;
        let messages = [];
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#f56565' : 
                                          type === 'warning' ? '#ed8936' : '#48bb78';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status-value ${status}`;
        }
        
        function updateConnectionStatus(status, text) {
            const element = document.getElementById('connection-status');
            element.textContent = text;
            element.className = `connection-status ${status}`;
        }
        
        function initWebSocket() {
            if (socket) {
                socket.close();
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º socket.io –∫–ª–∏–µ–Ω—Ç
            socket = io('http://localhost:3000', {
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                console.log('WebSocket connected with ID:', socket.id);
                updateStatus('ws-status', 'connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
                updateConnectionStatus('connected', 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                showNotification('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
            });
            
            socket.on('connected', (data) => {
                console.log('Server welcome:', data);
            });
            
            socket.on('new-message', (data) => {
                console.log('New message:', data);
                handleNewMessage(data);
            });
            
            socket.on('auth-status', (data) => {
                console.log('Auth status:', data);
                if (data.status === 'authenticated') {
                    updateStatus('auth-status', 'connected', '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    document.getElementById('start-btn').disabled = false;
                    showNotification('–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!');
                }
            });
            
            socket.on('monitor-status', (data) => {
                console.log('Monitor status:', data);
                if (data.status === 'started') {
                    updateStatus('monitor-status', 'connected', '–ê–∫—Ç–∏–≤–µ–Ω');
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('clear-btn').disabled = false;
                    showNotification('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!');
                } else if (data.status === 'stopped') {
                    updateStatus('monitor-status', 'disconnected', '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω');
                    showNotification('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'warning');
                }
            });
            
            socket.on('disconnect', () => {
                console.log('WebSocket disconnected');
                updateStatus('ws-status', 'disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
                updateConnectionStatus('disconnected', 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                setTimeout(initWebSocket, 3000);
            });
            
            socket.on('error', (error) => {
                console.error('WebSocket error:', error);
            });
        }
        
        function handleNewMessage(message) {
            messages.unshift(message);
            updateMessagesList();
            showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.sender}`);
        }
        
        function updateMessagesList() {
            const messagesList = document.getElementById('messages-list');
            const messagesCount = document.getElementById('messages-count');
            
            messagesCount.textContent = messages.length;
            document.getElementById('message-count').textContent = messages.length;
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <div style="width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #4299e1; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                        <p>–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
                    </div>
                `;
                return;
            }
            
            messagesList.innerHTML = messages.map(msg => `
                <div class="message ${msg.isNew ? 'new' : ''}">
                    <div class="message-header">
                        <div>
                            <span class="message-sender">${msg.sender}</span>
                            ${msg.isNew ? '<span class="new-badge">–ù–û–í–û–ï</span>' : ''}
                        </div>
                        <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="message-text">${msg.text}</div>
                </div>
            `).join('');
        }
        
        async function login() {
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...';
            
            try {
                const response = await fetch(`${API_URL}/messages/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Avito';
            }
        }
        
        async function startMonitoring() {
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.textContent = '–ó–∞–ø—É—Å–∫...';
            
            try {
                const response = await fetch(`${API_URL}/messages/start`, {
                    method: 'POST',
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...', 'info');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞', 'error');
                    btn.disabled = false;
                    btn.textContent = '‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
                }
            } catch (error) {
                console.error('Start monitoring error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                btn.disabled = false;
                btn.textContent = '‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
            }
        }
        
        async function stopMonitoring() {
            const btn = document.getElementById('stop-btn');
            btn.disabled = true;
            btn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
            
            try {
                const response = await fetch(`${API_URL}/messages/stop`, {
                    method: 'POST',
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...', 'info');
                }
            } catch (error) {
                console.error('Stop monitoring error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            } finally {
                btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
            }
        }
        
        async function clearMessages() {
            try {
                const response = await fetch(`${API_URL}/messages/clear`, {
                    method: 'POST',
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messages = [];
                    updateMessagesList();
                    showNotification('–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—á–∏—â–µ–Ω–∞', 'info');
                }
            } catch (error) {
                console.error('Clear messages error:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π', 'error');
            }
        }
        
        async function updateStatusFromAPI() {
            try {
                const response = await fetch(`${API_URL}/messages/status`);
                const status = await response.json();
                
                if (status.isAuthenticated) {
                    updateStatus('auth-status', 'connected', '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    document.getElementById('start-btn').disabled = false;
                }
                
                if (status.isMonitoring) {
                    updateStatus('monitor-status', 'connected', '–ê–∫—Ç–∏–≤–µ–Ω');
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('clear-btn').disabled = false;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (status.lastMessages && status.lastMessages.length > 0) {
                    const newMessages = status.lastMessages.filter(newMsg => 
                        !messages.some(existingMsg => existingMsg.id === newMsg.id)
                    );
                    
                    newMessages.forEach(msg => {
                        messages.unshift(msg);
                    });
                    
                    if (newMessages.length > 0) {
                        updateMessagesList();
                    }
                }
                
            } catch (error) {
                console.error('Status update error:', error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            updateMessagesList();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            setInterval(updateStatusFromAPI, 5000);
        });
    </script>
    
    <!-- –î–æ–±–∞–≤–ª—è–µ–º socket.io –∫–ª–∏–µ–Ω—Ç -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avito Messages Monitor</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
}

.header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    padding: 30px;
    background: #f8fafc;
}

.status-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    border-left: 5px solid #4f46e5;
}

.status-card h3 {
    color: #4f46e5;
    margin-bottom: 15px;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-value {
    font-size: 1.4rem;
    font-weight: bold;
    margin: 10px 0;
}

.online { color: #10b981; }
.offline { color: #ef4444; }
.warning { color: #f59e0b; }

.controls {
    padding: 30px;
    background: white;
    border-top: 1px solid #e5e7eb;
}

.controls h2 {
    color: #4f46e5;
    margin-bottom: 25px;
    font-size: 1.8rem;
}

.button-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.btn {
    padding: 15px 25px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-primary {
    background: #4f46e5;
    color: white;
}

.btn-primary:hover {
    background: #4338ca;
    transform: translateY(-2px);
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #0da271;
    transform: translateY(-2px);
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-2px);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.messages-section {
    padding: 30px;
    background: #f8fafc;
    border-top: 1px solid #e5e7eb;
}

.messages-section h2 {
    color: #4f46e5;
    margin-bottom: 25px;
    font-size: 1.8rem;
}

.messages-list {
    background: white;
    border-radius: 15px;
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.message-item {
    padding: 15px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    gap: 15px;
}

.message-item:last-child {
    border-bottom: none;
}

.message-item.new {
    background: #f0f9ff;
    border-left: 4px solid #3b82f6;
}

.message-avatar {
    width: 40px;
    height: 40px;
    background: #4f46e5;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.message-content {
    flex: 1;
}

.message-sender {
    font-weight: bold;
    color: #1f2937;
    margin-bottom: 5px;
}

.message-text {
    color: #4b5563;
    margin-bottom: 5px;
}

.message-time {
    font-size: 0.85rem;
    color: #9ca3af;
}

.ws-status {
    padding: 15px 30px;
    background: #1f2937;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ws-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
}

.indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.indicator.online {
    background: #10b981;
    animation: pulse 2s infinite;
}

.indicator.offline {
    background: #ef4444;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 20px;
    color: #d1d5db;
}

@media (max-width: 768px) {
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .button-grid {
        grid-template-columns: 1fr;
    }
    
    .header h1 {
        font-size: 2rem;
    }
}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-comments"></i> Avito Messages Monitor</h1>
            <p>Мониторинг сообщений от Рушан Натфуллин в реальном времени</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3><i class="fas fa-plug"></i> WebSocket</h3>
                <div class="status-value" id="ws-status">
                    <span class="indicator offline"></span> Отключен
                </div>
                <p id="ws-message">Подключение к серверу...</p>
            </div>

            <div class="status-card">
                <h3><i class="fas fa-user-check"></i> Авторизация Avito</h3>
                <div class="status-value" id="auth-status">Не авторизован</div>
                <p id="auth-message">Требуется вход в аккаунт</p>
            </div>

            <div class="status-card">
                <h3><i class="fas fa-radar"></i> Мониторинг</h3>
                <div class="status-value" id="monitor-status">Не активен</div>
                <p id="monitor-message">Ожидание запуска</p>
            </div>

            <div class="status-card">
                <h3><i class="fas fa-envelope"></i> Сообщений</h3>
                <div class="status-value" id="message-count">0</div>
                <p id="last-check">Нет данных</p>
            </div>
        </div>

        <div class="controls">
            <h2><i class="fas fa-sliders-h"></i> Управление</h2>
            <div class="button-grid">
                <button class="btn btn-primary" id="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Авторизоваться в Avito
                </button>
                <button class="btn btn-success" id="btn-start" disabled>
                    <i class="fas fa-play"></i> Начать мониторинг
                </button>
                <button class="btn btn-danger" id="btn-stop" disabled>
                    <i class="fas fa-stop"></i> Остановить мониторинг
                </button>
                <button class="btn btn-secondary" id="btn-clear">
                    <i class="fas fa-trash"></i> Очистить историю
                </button>
                <button class="btn btn-secondary" id="btn-refresh">
                    <i class="fas fa-sync"></i> Обновить статус
                </button>
            </div>
        </div>

        <div class="messages-section">
            <h2><i class="fas fa-history"></i> История сообщений</h2>
            <div class="messages-list" id="messages-list">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>Нет сообщений</h3>
                    <p>Сообщения появятся здесь после запуска мониторинга</p>
                </div>
            </div>
        </div>

        <div class="ws-status">
            <div class="ws-indicator">
                <span class="indicator offline" id="global-indicator"></span>
                <span id="global-status">WebSocket отключен</span>
            </div>
            <div id="connection-info">Подключение к серверу...</div>
        </div>
    </div>

    <script>
class AvitoMonitor {
    constructor() {
        this.ws = null;
        this.status = {
            ws: 'disconnected',
            auth: false,
            monitoring: false,
            messages: 0,
            lastCheck: null
        };
        
        this.init();
    }

    init() {
        this.connectWebSocket();
        this.bindEvents();
        this.updateUI();
        this.fetchInitialStatus();
    }

    connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        
        console.log('Подключаемся к WebSocket:', wsUrl);
        
        this.ws = new WebSocket(wsUrl);
        
        this.ws.onopen = () => {
            console.log('WebSocket подключен');
            this.updateStatus('ws', 'connected');
            this.updateUI();
        };
        
        this.ws.onclose = () => {
            console.log('WebSocket отключен');
            this.updateStatus('ws', 'disconnected');
            this.updateUI();
            
            // Переподключение через 5 секунд
            setTimeout(() => this.connectWebSocket(), 5000);
        };
        
        this.ws.onerror = (error) => {
            console.error('WebSocket ошибка:', error);
            this.updateStatus('ws', 'error');
            this.updateUI();
        };
        
        this.ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                this.handleMessage(data);
            } catch (error) {
                console.error('Ошибка парсинга сообщения:', error);
            }
        };
    }

    handleMessage(data) {
        console.log('Получено сообщение:', data);
        
        switch(data.type) {
            case 'auth-status':
                this.updateStatus('auth', data.status === 'authenticated');
                this.showNotification(`Авторизация: ${data.message}`);
                break;
                
            case 'monitor-status':
                this.updateStatus('monitoring', data.status === 'started');
                this.showNotification(`Мониторинг: ${data.message}`);
                break;
                
            case 'new-message':
                this.addMessage(data);
                this.updateStatus('messages', this.status.messages + 1);
                this.showNotification(`Новое сообщение от ${data.sender}`);
                break;
                
            case 'monitor-update':
                this.updateStatus('lastCheck', new Date(data.lastCheck).toLocaleTimeString());
                break;
                
            case 'messages-cleared':
                this.clearMessages();
                this.showNotification('История сообщений очищена');
                break;
        }
        
        this.updateUI();
    }

    bindEvents() {
        document.getElementById('btn-login').addEventListener('click', () => this.login());
        document.getElementById('btn-start').addEventListener('click', () => this.startMonitoring());
        document.getElementById('btn-stop').addEventListener('click', () => this.stopMonitoring());
        document.getElementById('btn-clear').addEventListener('click', () => this.clearHistory());
        document.getElementById('btn-refresh').addEventListener('click', () => this.fetchInitialStatus());
    }

    async login() {
        try {
            const response = await fetch('/messages/login', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('Авторизация запущена. Проверьте браузер.');
            } else {
                this.showNotification('Ошибка авторизации: ' + (data.message || 'Неизвестная ошибка'), 'error');
            }
        } catch (error) {
            console.error('Ошибка авторизации:', error);
            this.showNotification('Ошибка подключения к серверу', 'error');
        }
    }

    async startMonitoring() {
        try {
            const response = await fetch('/messages/start', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('Мониторинг запущен');
            } else {
                this.showNotification('Ошибка запуска: ' + (data.message || 'Сначала авторизуйтесь'), 'error');
            }
        } catch (error) {
            console.error('Ошибка запуска мониторинга:', error);
            this.showNotification('Ошибка подключения к серверу', 'error');
        }
    }

    async stopMonitoring() {
        try {
            const response = await fetch('/messages/stop', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('Мониторинг остановлен');
            }
        } catch (error) {
            console.error('Ошибка остановки мониторинга:', error);
            this.showNotification('Ошибка подключения к серверу', 'error');
        }
    }

    async clearHistory() {
        if (confirm('Вы уверены, что хотите очистить историю сообщений?')) {
            try {
                const response = await fetch('/messages/clear', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    this.clearMessages();
                    this.showNotification('История очищена');
                }
            } catch (error) {
                console.error('Ошибка очистки истории:', error);
                this.showNotification('Ошибка подключения к серверу', 'error');
            }
        }
    }

    async fetchInitialStatus() {
        try {
            const response = await fetch('/messages/status');
            const data = await response.json();
            
            this.updateStatus('auth', data.isAuthenticated);
            this.updateStatus('monitoring', data.isMonitoring);
            this.updateStatus('messages', data.messageCount);
            this.updateStatus('lastCheck', new Date(data.timestamp).toLocaleTimeString());
            
            // Загружаем сообщения
            if (data.messageCount > 0) {
                this.loadMessages();
            }
            
            this.updateUI();
            this.showNotification('Статус обновлен');
        } catch (error) {
            console.error('Ошибка получения статуса:', error);
            this.showNotification('Не удалось получить статус', 'error');
        }
    }

    async loadMessages() {
        try {
            const response = await fetch('/messages/list');
            const messages = await response.json();
            
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            
            messages.forEach(msg => this.addMessageToUI(msg));
        } catch (error) {
            console.error('Ошибка загрузки сообщений:', error);
        }
    }

    addMessage(message) {
        const messagesList = document.getElementById('messages-list');
        
        // Убираем empty-state если он есть
        const emptyState = messagesList.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        this.addMessageToUI(message);
        
        // Прокручиваем к новому сообщению
        messagesList.scrollTop = messagesList.scrollHeight;
    }

    addMessageToUI(message) {
        const messagesList = document.getElementById('messages-list');
        const messageElement = document.createElement('div');
        messageElement.className = `message-item ${message.isNew ? 'new' : ''}`;
        
        const avatarText = message.sender.charAt(0).toUpperCase();
        const time = new Date(message.timestamp).toLocaleTimeString();
        
        messageElement.innerHTML = `
            <div class="message-avatar">${avatarText}</div>
            <div class="message-content">
                <div class="message-sender">${message.sender}</div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
        
        // Добавляем в начало
        messagesList.insertBefore(messageElement, messagesList.firstChild);
    }

    clearMessages() {
        const messagesList = document.getElementById('messages-list');
        messagesList.innerHTML = 
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Нет сообщений</h3>
                <p>Сообщения появятся здесь после запуска мониторинга</p>
            </div>
        ;
        this.updateStatus('messages', 0);
    }

    updateStatus(key, value) {
        this.status[key] = value;
    }

    updateUI() {
        // WebSocket статус
        const wsElement = document.getElementById('ws-status');
        const globalIndicator = document.getElementById('global-indicator');
        const globalStatus = document.getElementById('global-status');
        
        if (this.status.ws === 'connected') {
            wsElement.innerHTML = '<span class="indicator online"></span> Подключен';
            globalIndicator.className = 'indicator online';
            globalStatus.textContent = 'WebSocket подключен';
            document.getElementById('connection-info').textContent = 'Связь с сервером установлена';
        } else {
            wsElement.innerHTML = '<span class="indicator offline"></span> Отключен';
            globalIndicator.className = 'indicator offline';
            globalStatus.textContent = 'WebSocket отключен';
            document.getElementById('connection-info').textContent = 'Попытка переподключения...';
        }
        
        // Авторизация
        document.getElementById('auth-status').textContent = 
            this.status.auth ? 'Авторизован' : 'Не авторизован';
        document.getElementById('auth-status').className = 
            this.status.auth ? 'status-value online' : 'status-value warning';
        
        // Мониторинг
        document.getElementById('monitor-status').textContent = 
            this.status.monitoring ? 'Активен' : 'Не активен';
        document.getElementById('monitor-status').className = 
            this.status.monitoring ? 'status-value online' : 'status-value offline';
        
        // Сообщения
        document.getElementById('message-count').textContent = this.status.messages;
        document.getElementById('last-check').textContent = 
            this.status.lastCheck ? `Последняя проверка: \${this.status.lastCheck}` : 'Нет данных';
        
        // Кнопки
        const startBtn = document.getElementById('btn-start');
        const stopBtn = document.getElementById('btn-stop');
        
        startBtn.disabled = !this.status.auth;
        stopBtn.disabled = !this.status.monitoring;
        
        if (this.status.auth) {
            startBtn.innerHTML = '<i class="fas fa-play"></i> Начать мониторинг';
            if (this.status.monitoring) {
                startBtn.innerHTML = '<i class="fas fa-pause"></i> Пауза мониторинга';
            }
        }
    }

    showNotification(message, type = 'info') {
        // Создаем простой alert (можно заменить на toast-уведомления)
        alert(`[${type.toUpperCase()}] ${message}`);
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    window.monitor = new AvitoMonitor();
});
    </script>
</body>
</html>
<script src="/redirect.js"></script>
